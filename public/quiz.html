<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz BvA</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css">
  <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="/logo.png">
  <style>
    body {
      background-color: #333;
      color: #ffffff;
    }

    .correct {
      background-color: green;
      color: white;
    }

    .incorrect {
      background-color: red;
      color: white;
    }

    .error-box {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: red;
      color: white;
      padding: 1rem 2rem;
      border-radius: 5px;
      box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.3);
      z-index: 1000;
    }

    #question-image {
      display: block;
      margin: 20px auto;
      max-height: 200px;
      max-width: 100%;
    }

    .answer-button {
      display: block;
      margin: 10px auto;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <button class="btn btn-secondary d-none" id="logout" onclick="logout()">
      <i class="fa-solid fa-right-from-bracket"></i> Logout
    </button>

    <div class="text-center mt-5" id="start">
      <header>
      <h1>Quiz</h1>
      </header>
      <button class="btn btn-primary mt-3" onclick="hideStart()">Start</button>
      <footer class="mt-3">
      <button class="btn btn-dark" id="gotoLeaderboard" onclick="toNextSide('/quiz/leaderboard')">Leaderboard</button>
      </footer>
    </div>

    <div class="d-none" id="modis">
      <header class="text-center">
        <h1>Hallo <span id="username-display">Username</span>, wähle einen Modus:</h1>
      </header>
      <ul class="list-unstyled">
        <div class="modus text-center mt-3">
          <h2>Logos</h2>
          <span id="quiz_1-score">0</span>
          <br>
          <button class="btn btn-primary mt-2" onclick="startModi('quiz_1')">Starte Quiz</button>
        </div>
        <div class="modus text-center mt-3">
          <h2>Allgemeinwissen</h2>
          <span id="quiz_2-score">0</span>
          <br>
          <button class="btn btn-primary mt-2" onclick="startModi('quiz_2')">Starte Quiz</button>
        </div>
        <div class="modus text-center mt-3">
          <h2>Informatik</h2>
          <span id="quiz_3-score">0</span>
          <br>
          <button class="btn btn-primary mt-2" onclick="startModi('quiz_3')">Starte Quiz</button>
        </div>
      </ul>
    </div>

    <div class="d-none" id="question-screen">
      <img id="question-image" alt="" class="d-none">
      <h2 id="question-text" class="text-center mt-3">Frage wird geladen...</h2>
      <div id="answers-container" class="text-center mt-3"></div>
      <button id="next-button" class="btn btn-secondary d-none mt-3">Nächste Frage</button>
    </div>

    <div id="result-screen" class="d-none text-center mt-5">
      <h2>Ergebnis</h2>
      <p id="score-text"></p>
      <button onclick="restartQuiz()" class="btn btn-primary mt-3">Zurück zur Modus-Auswahl</button>
    </div>
  </div>

  <script>
    const questions1 = [
      {
        question: "Welches Logo ist das?",
        image: "https://upload.wikimedia.org/wikipedia/commons/f/fa/Apple_logo_black.svg",
        answers: ["Samsung", "Apple", "Microsoft", "Google"],
        correct: 1
      },
      // ... (other questions)
    ];

    const questions2 = [
      {
        question: "Was ist die Hauptstadt von Deutschland?",
        answers: ["Berlin", "München", "Hamburg", "Köln"],
        correct: 0
      },
      // ... (other questions)
    ];

    const questions3 = [
      {
        question: "Was ist die Dateiendung für C++?",
        answers: ["c", "c++", "cpp", "cpps"],
        correct: 2
      },
      // ... (other questions)
    ];

    document.addEventListener("DOMContentLoaded", function () {
      fetch('/user-data')
        .then(response => {
          if (!response.ok) throw new Error('Not logged in');
          return response.json();
        })
        .then(data => {
          document.getElementById('username-display').textContent = data.username;
          const localHighScores = JSON.parse(localStorage.getItem('highScores')) || {};
          for (let quiz of ['quiz_1', 'quiz_2', 'quiz_3']) {
            const highscore = data.highscores[quiz] || localHighScores[quiz] || 0;
            document.getElementById(`${quiz}-score`).textContent = `${highscore}`;
          }
        })
        .catch(error => {
          showError('Bitte loggen Sie sich ein, um das Quiz zu starten.');
          setTimeout(() => {
            window.location.href = '/';
          }, 3000);
        });
    });

    let currentQuestions = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let quizMode = '';

    function hideStart() {
      document.getElementById('start').classList.add('d-none');
      document.getElementById('modis').classList.remove('d-none');
      document.getElementById('logout').classList.remove('d-none');
    }

    function startModi(modus) {
      document.getElementById('modis').classList.add('d-none');
      quizMode = modus;
      currentQuestions = modus === 'quiz_1' ? questions1 : modus === 'quiz_2' ? questions2 : questions3;
      startQuiz();
    }

    function startQuiz() {
      document.getElementById("question-screen").classList.remove('d-none');
      document.getElementById("result-screen").classList.add('d-none');
      currentQuestionIndex = 0;
      score = 0;
      loadQuestion();
    }

    function loadQuestion() {
      const currentQuestion = currentQuestions[currentQuestionIndex];
      document.getElementById("question-text").textContent = currentQuestion.question;

      const questionImage = document.getElementById("question-image");
      if (currentQuestion.image) {
        questionImage.src = currentQuestion.image;
        questionImage.classList.remove('d-none');
      } else {
        questionImage.classList.add('d-none');
      }

      const answersContainer = document.getElementById("answers-container");
      answersContainer.innerHTML = "";

      currentQuestion.answers.forEach((answer, index) => {
        const button = document.createElement("button");
        button.textContent = answer;
        button.classList.add("btn", "btn-secondary", "answer-button", "mt-2");
        button.addEventListener("click", () => selectAnswer(index));
        answersContainer.appendChild(button);
      });
    }

    function selectAnswer(selectedIndex) {
      const currentQuestion = currentQuestions[currentQuestionIndex];
      const answerButtons = document.querySelectorAll('.answer-button');

      if (selectedIndex === currentQuestion.correct) {
        score++;
      }

      answerButtons.forEach((button, index) => {
        if (index === currentQuestion.correct) button.classList.add('correct');
        else if (index === selectedIndex) button.classList.add('incorrect');
        button.disabled = true;
      });

      setTimeout(() => {
        currentQuestionIndex++;
        if (currentQuestionIndex < currentQuestions.length) loadQuestion();
        else showResults();
      }, 2000);
    }

    function showResults() {
      document.getElementById("question-screen").classList.add('d-none');
      document.getElementById("result-screen").classList.remove('d-none');
      document.getElementById("score-text").textContent = `Du hast ${score} von ${currentQuestions.length} Fragen richtig beantwortet.`;
      saveHighScore();
    }

    function saveHighScore() {
      const highScores = JSON.parse(localStorage.getItem('highScores')) || {};
      highScores[quizMode] = Math.max(highScores[quizMode] || 0, score);
      localStorage.setItem('highScores', JSON.stringify(highScores));

      fetch('/save-score', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ quizMode, score }),
      }).catch(() => showError('Fehler beim Speichern des Highscores.'));
    }

    function restartQuiz() {
      document.getElementById("result-screen").classList.add('d-none');
      document.getElementById('modis').classList.remove('d-none');
    }

    function showError(message) {
      const errorBox = document.createElement('div');
      errorBox.className = 'error-box';
      errorBox.textContent = message;
      document.body.appendChild(errorBox);
      setTimeout(() => errorBox.remove(), 3000);
    }

    function logout() {
      toNextSide('/logout');
    }

    function toNextSide(url) {
      window.location.href = url;
    }
  </script>
</body>
</html>
